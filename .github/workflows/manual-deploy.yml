name: Recover Deploy (multi-environment with validation)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ"
        required: true
        type: choice
        options:
          - rc
          - pre-stg1
          - pre-stg2
          - pre-stg3
          - pre-stg4
          - pre-stg5
          - stg
          - prd
      ref_name:
        description: "ã‚¿ã‚° or ãƒ–ãƒ©ãƒ³ãƒåï¼ˆä¾‹: v1.2.3, mainï¼‰"
        required: true

jobs:
  input-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate ref and environment match
        run: |
          echo "ðŸ” å…¥åŠ›ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼ä¸­..."
          REF="${{ github.event.inputs.ref_name }}"
          ENV="${{ github.event.inputs.environment }}"
          TOKEN=${{ secrets.GITHUB_TOKEN }}
          REPO_URL="https://${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"


          if git ls-remote --tags "$REPO_URL" "refs/tags/${REF}" | grep -q .; then
            REF_TYPE="tag"
          elif git ls-remote --heads "$REPO_URL" "refs/heads/${REF}" | grep -q .; then
            REF_TYPE="branch"
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: å…¥åŠ›ã•ã‚ŒãŸ '${REF}' ã¯å­˜åœ¨ã—ãªã„ã‚¿ã‚°ãƒ»ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

          echo "âœ… æ¤œå‡ºã•ã‚ŒãŸ ${REF} ã¯ ${REF_TYPE} ã§ã™"

          if [[ "${ENV}" =~ ^(stg|prd)$ && "${REF_TYPE}" != "tag" ]]; then
            echo "âŒ '${ENV}' ã«ã¯ã‚¿ã‚°ã®ã¿æŒ‡å®šå¯èƒ½ã§ã™ãŒã€'${REF}' ã¯ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

          echo "âœ… å…¥åŠ›æ¤œè¨¼ã‚¯ãƒªã‚¢: '${REF}' ã‚’ '${ENV}' ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"

  deploy:
    name: Deploy
    needs: input-validate
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Echo deployment
        run: |
          echo "ðŸš€ ç’°å¢ƒ '${{ github.event.inputs.environment }}' ã« '${{ github.event.inputs.ref_name }}' ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"

  update-release-record:
    name: Update YAML record
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
            echo "TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
            echo "REF_NAME=${{ github.event.inputs.ref_name }}" >> $GITHUB_OUTPUT
            echo "ENV_NAME=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "ACTOR=${{ github.actor }}" >> $GITHUB_OUTPUT

      - name: Install yq
        run: |
            sudo apt-get update && sudo apt-get install -y jq
            curl -L https://github.com/mikefarah/yq/releases/download/v4.35.1/yq_linux_amd64 -o /usr/local/bin/yq
            chmod +x /usr/local/bin/yq

      - name: Ensure YAML file exists
        run: |
            mkdir -p .release-state
            touch .release-state/releases.yml
            [ -s .release-state/releases.yml ] || echo "{}" > .release-state/releases.yml

      - name: Update releases.yml
        run: |
            yq -i ".${{ steps.vars.outputs.ENV_NAME }}.ref = \"${{ steps.vars.outputs.REF_NAME }}\"" .release-state/releases.yml
            yq -i ".${{ steps.vars.outputs.ENV_NAME }}.deployed_at = \"${{ steps.vars.outputs.TIME }}\"" .release-state/releases.yml
            yq -i ".${{ steps.vars.outputs.ENV_NAME }}.deployed_by = \"${{ steps.vars.outputs.ACTOR }}\"" .release-state/releases.yml

      - name: Commit and push
        run: |
            git remote set-url origin https://nakashimamasaya:${BOT_PAT}@github.com/nakashimamasaya/test-actions-apply-test.git
            git add .release-state/releases.yml
            git commit -m "update release record: ${{ steps.vars.outputs.ENV_NAME }} => ${{ steps.vars.outputs.REF_NAME }}"
            git push origin HEAD:main
        env:
            GH_PAT: ${{ secrets.NAKA_PAT }}
