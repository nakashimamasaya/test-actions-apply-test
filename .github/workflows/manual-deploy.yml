name: Recover Deploy (multi-environment with validation)

on:
  workflow_dispatch:
    inputs:
      ref_name:
        description: "ã‚¿ã‚° or ãƒ–ãƒ©ãƒ³ãƒåï¼ˆä¾‹: v1.2.3, mainï¼‰"
        required: true
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ"
        required: true
        type: choice
        options:
          - rc
          - pre-stg1
          - pre-stg2
          - pre-stg3
          - pre-stg4
          - pre-stg5
          - stg
          - prd

jobs:
  input-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate ref and environment match
        run: |
          echo "ğŸ” å…¥åŠ›ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼ä¸­..."
          REF="${{ github.event.inputs.ref_name }}"
          ENV="${{ github.event.inputs.environment }}"
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"

          if git ls-remote --tags "$REPO_URL" "refs/tags/${REF}" | grep -q .; then
            REF_TYPE="tag"
          elif git ls-remote --heads "$REPO_URL" "refs/heads/${REF}" | grep -q .; then
            REF_TYPE="branch"
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: å…¥åŠ›ã•ã‚ŒãŸ '${REF}' ã¯å­˜åœ¨ã—ãªã„ã‚¿ã‚°ãƒ»ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

          echo "âœ… æ¤œå‡ºã•ã‚ŒãŸ ${REF} ã¯ ${REF_TYPE} ã§ã™"

          if [[ "${ENV}" =~ ^(stg|prd)$ && "${REF_TYPE}" != "tag" ]]; then
            echo "âŒ '${ENV}' ã«ã¯ã‚¿ã‚°ã®ã¿æŒ‡å®šå¯èƒ½ã§ã™ãŒã€'${REF}' ã¯ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

          echo "âœ… å…¥åŠ›æ¤œè¨¼ã‚¯ãƒªã‚¢: '${REF}' ã‚’ '${ENV}' ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"

  deploy:
    name: PRD Deploy Execution
    needs: input-validate
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Echo deployment
        run: |
          echo "ğŸš€ ç’°å¢ƒ '${{ github.event.inputs.environment }}' ã« '${{ github.event.inputs.ref_name }}' ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"
